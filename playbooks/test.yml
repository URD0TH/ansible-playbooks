---
- name: Update packages and check for reboot requirement
  hosts: all
  become: yes
  vars:
    ntfy_url: "https://ntfy.bnds.link/NJWeS1A7FZHj5bKQ"
    ntfy_token: "{{ token }}"
    

  tasks:
    - name: Bloque de actualizaci√≥n y verificaci√≥n
      block:
        - name: Update packages with apt
          when: ansible_pkg_mgr == 'apt'
          ansible.builtin.apt:
            update_cache: true
          register: update_result

        - name: Enviar notificaci√≥n si la actualizaci√≥n tuvo √©xito
          command: >
            curl -H 'Authorization: Bearer {{ ntfy_token }}'
                 -H 'Title: Actualizaci√≥n exitosa en {{ ansible_hostname }}'
                 -H 'Priority: low'
                 -d 'Actualizaci√≥n de paquetes exitosa üòÄ'
                 {{ ntfy_url }}
          when: update_result.changed

        - name: Enviar notificaci√≥n si hubo un error en la actualizaci√≥n
          command: >
            curl -H 'Authorization: Bearer {{ ntfy_token }}'
                 -H 'Title: Error en actualizaci√≥n en {{ ansible_hostname }}'
                 -H 'Priority: high'
                 -d 'Error al actualizar paquetes üòü'
                 {{ ntfy_url }}
          when: update_result.failed

        - name: Upgrade packages with apt
          when: ansible_pkg_mgr == 'apt'
          ansible.builtin.apt:
            upgrade: dist
          register: upgrade_result

        - name: Enviar notificaci√≥n si la mejora tuvo √©xito
          command: >
            curl -H 'Authorization: Bearer {{ ntfy_token }}'
                 -H 'Title: Mejora exitosa en {{ ansible_hostname }}'
                 -H 'Priority: low'
                 -d 'Mejora de paquetes exitosa üòÄ'
                 {{ ntfy_url }}
          when: upgrade_result.changed

        - name: Enviar notificaci√≥n si hubo un error en la mejora
          command: >
            curl -H 'Authorization: Bearer {{ ntfy_token }}'
                 -H 'Title: Error en mejora en {{ ansible_hostname }}'
                 -H 'Priority: high'
                 -d 'Error al mejorar paquetes üòü'
                 {{ ntfy_url }}
          when: upgrade_result.failed

        - name: Check if system reboot is required
          when: ansible_pkg_mgr == 'apt'
          ansible.builtin.stat:
            path: /run/reboot-required
          register: reboot_required

        - name: Enviar notificaci√≥n si el reinicio es necesario
          command: >
            curl -H 'Authorization: Bearer {{ ntfy_token }}'
                 -H 'Title: Reinicio necesario en {{ ansible_hostname }}'
                 -H 'Priority: low'
                 -d 'Reinicio del sistema necesario üîÑ'
                 {{ ntfy_url }}
          when: reboot_required.stat.exists

        - name: Enviar notificaci√≥n si el reinicio no es necesario
          command: >
            curl -H 'Authorization: Bearer {{ ntfy_token }}'
                 -H 'Title: Reinicio no necesario en {{ ansible_hostname }}'
                 -H 'Priority: low'
                 -d 'No es necesario reiniciar el sistema ‚ùå'
                 {{ ntfy_url }}
          when: not reboot_required.stat.exists

        - name: Enviar notificaci√≥n de √©xito final
          command: >
            curl -H 'Authorization: Bearer {{ ntfy_token }}'
                 -H 'Title: Todas las tareas completadas en {{ ansible_hostname }}'
                 -H 'Priority: low'
                 -d 'Todas las tareas han sido ejecutadas con √©xito üòÄ'
                 {{ ntfy_url }}

      rescue:
        - name: Enviar notificaci√≥n si alguna tarea falla
          command: >
            curl -H 'Authorization: Bearer {{ ntfy_token }}'
                 -H 'Title: Error en tarea en {{ ansible_hostname }}'
                 -H 'Priority: high'
                 -d 'Error durante la ejecuci√≥n del playbook ‚ùå'
                 {{ ntfy_url }}