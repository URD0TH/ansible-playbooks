---
- name: Actualizar paquetes del sistema y reiniciar si es necesario
  hosts: all
  become: yes

  tasks:
    - name: Actualizar todos los paquetes del sistema
      apt:
        update_cache: yes
        upgrade: yes
      register: update_result

    - name: revisar si es necesario reiniciar
    ansible.builtin.stat:
      path: /var/run/reboot-required
      get_checksum: no
    register: reboot_required_file

    - name: reiniciar (si es necesario)
      ansible.builtin.reboot:
        test_command: uptime
      when: reboot_required_file.stat.exists == true
      register: reboot_result
      
    - name: remover dependencias que no son necesarias.
      ansible.builtin.apt:
        autoremove: yes

    # - name: Reiniciar el servidor solo si es necesario
    #   reboot:
    #     reboot_timeout: 300
    #     test_command: uptime
    #   register: reboot_result

    - name: Enviar notificaci√≥n si la actualizaci√≥n tuvo √©xito
      command: "curl -H 'Authorization: Bearer {{ token }}' -H 'Title: Actualizaci√≥n exitosa en {{ ansible_hostname }}' -H 'Priority: low' -d 'Actualizaci√≥n de paquetes exitosa üòÄ' https://ntfy.bnds.link/upgrade"
      when: update_result.changed

    - name: Enviar notificaci√≥n si hubo un error en la actualizaci√≥n
      command: "curl -H 'Authorization: Bearer {{ token }}' -H 'Title: Error en actualizaci√≥n en {{ ansible_hostname }}' -H 'Priority: high' -d 'Error al actualizar paquetes üòü' https://ntfy.bnds.link/upgrade"
      when: update_result.failed

    - name: Enviar notificaci√≥n si el reinicio fue necesario y tuvo √©xito
      command: "curl -H 'Authorization: Bearer {{ token }}' -H 'Title: Reinicio exitoso en {{ ansible_hostname }}' -H 'Priority: low' -d 'Servidor reiniciado correctamente üîÑ' https://ntfy.bnds.link/upgrade"
      when: reboot_result.rebooted

    - name: Enviar notificaci√≥n si hubo un error en el reinicio
      command: "curl -H 'Authorization: Bearer {{ token }}' -H 'Title: Error en reinicio en {{ ansible_hostname }}' -H 'Priority: high' -d 'Error al reiniciar el servidor ‚ùå' https://ntfy.bnds.link/upgrade"
      when: reboot_result.failed
